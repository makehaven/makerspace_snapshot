<?php

/**
 * @file
 * Module file for makerspace_snapshot.
 */

use Drupal\Core\Datetime\DrupalDateTime;

/**
 * Implements hook_cron().
 *
 * Runs based on the configured snapshot interval.
 */
function makerspace_snapshot_cron() {
  $config = \Drupal::config('makerspace_snapshot.settings');
  $interval = $config->get('interval');
  $now = new DrupalDateTime('now');

  $should_run = FALSE;
  $snapshot_type = '';

  switch ($interval) {
    case 'daily':
      $should_run = TRUE;
      $snapshot_type = 'daily';
      break;
    case 'monthly':
      if ($now->format('j') === '1') {
        $should_run = TRUE;
        $snapshot_type = 'monthly';
      }
      break;
    case 'quarterly':
      if (in_array($now->format('n'), [1, 4, 7, 10]) && $now->format('j') === '1') {
        $should_run = TRUE;
        $snapshot_type = 'quarterly';
      }
      break;
    case 'annually':
      if ($now->format('n') === '1' && $now->format('j') === '1') {
        $should_run = TRUE;
        $snapshot_type = 'annually';
      }
      break;
  }

  if ($should_run) {
    // Use the run date as the snapshot anchor so monthly snapshots taken on
    // the first of the month are stored as that month (for example 2026-02-01).
    $snapshot_date = $now->format('Y-m-d');
    // Period-based metrics should use the completed period prior to the run.
    $period_reference_date = $snapshot_date;
    if (in_array($snapshot_type, ['monthly', 'quarterly', 'annually'], TRUE)) {
      $period_reference_date = (new DrupalDateTime('yesterday'))->format('Y-m-d');
    }
    /** @var \Drupal\makerspace_snapshot\SnapshotService $snapshotService */
    $snapshotService = \Drupal::service('makerspace_snapshot.snapshot_service');
    if ($snapshotService->snapshotExists($snapshot_type, $snapshot_date, 'automatic_cron')) {
      \Drupal::logger('makerspace_snapshot')->notice(
        'Skipped duplicate automatic @type snapshot for @date.',
        [
          '@type' => $snapshot_type,
          '@date' => (new DrupalDateTime($snapshot_date))->format('Y-m-01'),
        ]
      );
      return;
    }

    $snapshotService->takeSnapshot($snapshot_type, FALSE, $snapshot_date, 'automatic_cron', NULL, $period_reference_date);
  }
}

/**
 * Responds with KPI values that should be stored during snapshot runs.
 *
 * Modules can implement this hook to persist KPI metrics alongside the core
 * membership counts. The callback receives an associative array with keys:
 * - snapshot_id: The database ID of the snapshot (may be 0 during collection).
 * - snapshot_type: Snapshot cadence (monthly, annually, etc.).
 * - snapshot_date: String date in Y-m-d format (first of month).
 * - period_start / period_end: Datetime strings delimiting the period.
 * - members_active / members_paused / members_lapsed / joins / cancels /
 *   net_change: Aggregate membership counts computed by the snapshot service.
 * - is_test: Whether the snapshot has been flagged as test data.
 *
 * The hook should return an array keyed by KPI machine name. Each value can be
 * either a scalar metric value or an array with keys:
 * - value (required): Numeric value to persist.
 * - period_year (optional): Overrides the default year derived from snapshot_date.
 * - period_month (optional): Overrides the default month derived from snapshot_date.
 * - meta (optional): Serializable array of supplementary data.
 *
 * @param array $context
 *   Snapshot context values.
 *
 * @return array
 *   KPI values keyed by KPI ID.
 */
function hook_makerspace_snapshot_collect_kpi(array $context): array {
  return [
    'total_active_members' => [
      'value' => $context['members_active'] ?? 0,
      'period_year' => (int) date('Y', strtotime($context['snapshot_date'])),
      'period_month' => (int) date('n', strtotime($context['snapshot_date'])),
    ],
  ];
}
