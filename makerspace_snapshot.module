<?php

/**
 * @file
 * Module file for makerspace_snapshot.
 */

use Drupal\Core\Datetime\DrupalDateTime;

/**
 * Implements hook_cron().
 *
 * Runs based on the configured snapshot interval.
 */
function makerspace_snapshot_cron() {
  $config = \Drupal::config('makerspace_snapshot.settings');
  $interval = $config->get('interval');
  $now = new DrupalDateTime('now');

  $should_run = FALSE;
  $snapshot_type = '';

  switch ($interval) {
    case 'daily':
      $should_run = TRUE;
      $snapshot_type = 'daily';
      break;
    case 'monthly':
      if ($now->format('j') === '1') {
        $should_run = TRUE;
        $snapshot_type = 'monthly';
      }
      break;
    case 'quarterly':
      if (in_array($now->format('n'), [1, 4, 7, 10]) && $now->format('j') === '1') {
        $should_run = TRUE;
        $snapshot_type = 'quarterly';
      }
      break;
    case 'annually':
      if ($now->format('n') === '1' && $now->format('j') === '1') {
        $should_run = TRUE;
        $snapshot_type = 'annually';
      }
      break;
  }

  if ($should_run) {
    $snapshot_date = (new DrupalDateTime('yesterday'))->format('Y-m-d');
    \Drupal::service('makerspace_snapshot.snapshot_service')->takeSnapshot($snapshot_type, FALSE, $snapshot_date);
  }
}
